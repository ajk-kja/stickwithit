<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MetroGnome | Stick With It</title>
    <meta name="description" content="A clean, accessible metronome for drummers">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/assets/StickWithItBlack.png">
    <style>
        :root {
            --bg: #000;
            --surface: #111;
            --surface-2: #1a1a1a;
            --border: #333;
            --text: #fff;
            --text-muted: #888;
            --accent: #e63946;
            --accent-dim: rgba(230, 57, 70, 0.3);
            --beat-inactive: #222;
            --beat-fill: #e63946;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        /* Header */
        .header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .header a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Main Container */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Beat Display */
        .beat-display {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.25rem;
            flex-shrink: 0;
        }

        .beat-grid {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            max-width: 100%;
        }

        .beat-block {
            aspect-ratio: 1;
            min-height: 40px;
            max-height: 60px;
            background: var(--beat-inactive);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.15s, box-shadow 0.15s;
            border: 2px solid transparent;
        }

        .beat-block:active {
            transform: scale(0.95);
        }

        /* Accent state: red border + subtle glow */
        .beat-block.accented {
            border-color: var(--accent);
            box-shadow: 0 0 12px var(--accent-dim), inset 0 0 20px rgba(230, 57, 70, 0.1);
        }

        /* Normal state: subtle white border */
        .beat-block.normal {
            border-color: var(--border);
        }

        /* Muted state: dimmed with diagonal line */
        .beat-block.muted {
            opacity: 0.5;
            border-color: transparent;
        }

        .beat-block.muted::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                transparent 45%,
                var(--text-muted) 45%,
                var(--text-muted) 55%,
                transparent 55%
            );
            opacity: 0.3;
            pointer-events: none;
            z-index: 2;
        }

        .beat-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: var(--accent);
            transition: height 0.05s linear;
            border-radius: 0 0 6px 6px;
        }

        .beat-block.filling .beat-fill {
            border-radius: 6px;
        }

        .beat-block.muted .beat-fill {
            background: var(--text-muted);
        }

        .beat-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            z-index: 1;
            transition: color 0.1s;
        }

        .beat-block.accented .beat-number {
            color: var(--accent);
        }

        .beat-block.active .beat-number {
            color: var(--text);
        }

        /* State label - shows at bottom */
        .beat-state {
            position: absolute;
            bottom: 3px;
            left: 0;
            right: 0;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            color: var(--text-muted);
            opacity: 0.7;
            z-index: 1;
        }

        .beat-block.accented .beat-state {
            color: var(--accent);
        }

        /* BPM Display */
        .bpm-section {
            text-align: center;
            flex-shrink: 0;
        }

        .bpm-value {
            font-size: 4.5rem;
            font-weight: 200;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .bpm-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0.25rem;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-row {
            display: flex;
            gap: 1rem;
            align-items: stretch;
        }

        .control-group {
            flex: 1;
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
        }

        .control-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            display: block;
        }

        /* Time Signature */
        .time-sig {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .time-sig-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-sig-value {
            font-size: 2rem;
            font-weight: 600;
            width: 3rem;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        .time-sig-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--surface-2);
            color: var(--text);
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .time-sig-btn:hover {
            background: var(--border);
        }

        .time-sig-btn:active {
            background: var(--accent);
        }

        .time-sig-divider {
            font-size: 2.5rem;
            font-weight: 200;
            color: var(--text-muted);
        }

        /* Subdivision */
        .subdivision-picker {
            display: flex;
            gap: 0.5rem;
        }

        .subdiv-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .subdiv-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
            font-weight: 600;
        }

        /* BPM Slider */
        .bpm-slider-container {
            padding: 0.5rem 0;
        }

        input[type="range"] {
            width: 100%;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            margin-top: -10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-track {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Volume */
        .volume-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .volume-icon {
            font-size: 1.25rem;
        }

        .volume-slider {
            flex: 1;
        }

        /* Play Button */
        .play-btn {
            width: 100%;
            padding: 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--accent);
            color: var(--bg);
        }

        .play-btn:hover {
            filter: brightness(1.1);
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        .play-btn.playing {
            background: var(--text);
            color: var(--bg);
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .toggle-label {
            font-size: 0.9rem;
        }

        .toggle {
            width: 52px;
            height: 32px;
            background: var(--surface-2);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 26px;
            height: 26px;
            background: var(--text);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle.active .toggle-knob {
            transform: translateX(20px);
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Landscape optimization */
        @media (min-width: 600px) and (max-height: 500px) {
            .main {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .beat-display {
                flex: 1 1 100%;
            }
            .bpm-section {
                flex: 0 0 auto;
            }
            .controls {
                flex: 1;
            }
        }

        /* Desktop */
        @media (min-width: 768px) {
            .main {
                max-width: 500px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" aria-label="Back to Stick With It">‚Üê Home</a>
        <h1>MetroGnome</h1>
        <div style="width: 50px;"></div>
    </header>

    <main class="main">
        <!-- Beat Display -->
        <section class="beat-display" aria-label="Beat visualization">
            <div class="beat-grid" id="beatGrid" role="group" aria-label="Beat indicators">
                <!-- Beats generated by JS -->
            </div>
        </section>

        <!-- BPM Display -->
        <section class="bpm-section">
            <div class="bpm-value" id="bpmValue" aria-live="polite">120</div>
            <div class="bpm-label">BPM</div>
        </section>

        <!-- Controls -->
        <div class="controls">
            <!-- Time Signature & Subdivision -->
            <div class="control-row">
                <div class="control-group">
                    <label class="control-label">Time Signature</label>
                    <div class="time-sig">
                        <div class="time-sig-picker">
                            <button class="time-sig-btn" data-target="top" data-dir="up" aria-label="Increase beats">+</button>
                            <div class="time-sig-value" id="timeSigTop">4</div>
                            <button class="time-sig-btn" data-target="top" data-dir="down" aria-label="Decrease beats">‚àí</button>
                        </div>
                        <div class="time-sig-divider">/</div>
                        <div class="time-sig-picker">
                            <button class="time-sig-btn" data-target="bottom" data-dir="up" aria-label="Increase note value">+</button>
                            <div class="time-sig-value" id="timeSigBottom">4</div>
                            <button class="time-sig-btn" data-target="bottom" data-dir="down" aria-label="Decrease note value">‚àí</button>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Subdivision</label>
                    <div class="subdivision-picker" role="radiogroup" aria-label="Subdivision selection">
                        <button class="subdiv-btn active" data-subdiv="1" role="radio" aria-checked="true">1</button>
                        <button class="subdiv-btn" data-subdiv="2" role="radio" aria-checked="false">2</button>
                        <button class="subdiv-btn" data-subdiv="3" role="radio" aria-checked="false">3</button>
                        <button class="subdiv-btn" data-subdiv="4" role="radio" aria-checked="false">4</button>
                    </div>
                </div>
            </div>

            <!-- BPM Slider -->
            <div class="control-group">
                <label class="control-label" for="bpmSlider">Tempo</label>
                <div class="bpm-slider-container">
                    <input type="range" id="bpmSlider" min="30" max="300" value="120" aria-label="BPM">
                </div>
                <div class="slider-labels">
                    <span>30</span>
                    <span>300</span>
                </div>
            </div>

            <!-- Volume -->
            <div class="control-group">
                <label class="control-label">Volume</label>
                <div class="volume-row">
                    <span class="volume-icon">üîà</span>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="80" aria-label="Volume">
                    <span class="volume-icon">üîä</span>
                </div>
            </div>

            <!-- Flash Toggle -->
            <div class="control-group">
                <div class="toggle-row">
                    <span class="toggle-label">Flash on Beat</span>
                    <div class="toggle" id="flashToggle" role="switch" aria-checked="false" tabindex="0">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>

            <!-- Play Button -->
            <button class="play-btn" id="playBtn" aria-label="Start metronome">
                Start
            </button>
        </div>
    </main>

    <script>
        // === Audio Context ===
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // === State ===
        const state = {
            isPlaying: false,
            bpm: 120,
            beatsPerMeasure: 4,
            noteValue: 4,
            subdivision: 1,
            volume: 0.8,
            flashEnabled: false,
            currentBeat: 0,
            currentSubdiv: 0,
            beatAccents: [4, 2, 2, 2], // 4=accented, 2=normal, 0=muted
            nextNoteTime: 0,
            schedulerTimer: null,
            animationFrame: null
        };

        // === DOM Elements ===
        const els = {
            beatGrid: document.getElementById('beatGrid'),
            bpmValue: document.getElementById('bpmValue'),
            bpmSlider: document.getElementById('bpmSlider'),
            volumeSlider: document.getElementById('volumeSlider'),
            timeSigTop: document.getElementById('timeSigTop'),
            timeSigBottom: document.getElementById('timeSigBottom'),
            playBtn: document.getElementById('playBtn'),
            flashToggle: document.getElementById('flashToggle'),
            subdivBtns: document.querySelectorAll('.subdiv-btn'),
            timeSigBtns: document.querySelectorAll('.time-sig-btn')
        };

        // === Beat Grid ===
        function createBeatGrid() {
            els.beatGrid.innerHTML = '';
            
            // Adjust grid columns based on beat count
            const cols = state.beatsPerMeasure <= 4 ? state.beatsPerMeasure 
                       : state.beatsPerMeasure <= 8 ? 4 
                       : state.beatsPerMeasure <= 12 ? 4
                       : Math.min(4, Math.ceil(state.beatsPerMeasure / 4));
            
            els.beatGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            // Resize accents array
            const oldAccents = [...state.beatAccents];
            state.beatAccents = [];
            for (let i = 0; i < state.beatsPerMeasure; i++) {
                state.beatAccents[i] = i < oldAccents.length ? oldAccents[i] : (i === 0 ? 4 : 2);
            }

            // Create beat blocks
            for (let i = 0; i < state.beatsPerMeasure; i++) {
                const block = document.createElement('div');
                block.className = 'beat-block';
                block.dataset.beat = i;
                
                // Set initial state class
                const accent = state.beatAccents[i];
                if (accent === 0) block.classList.add('muted');
                else if (accent === 4) block.classList.add('accented');
                else block.classList.add('normal');

                const stateLabel = accent === 4 ? 'accent' : accent === 0 ? 'mute' : '';

                block.innerHTML = `
                    <div class="beat-fill"></div>
                    <span class="beat-number">${i + 1}</span>
                    <span class="beat-state">${stateLabel}</span>
                `;

                // Click to cycle accent
                block.addEventListener('click', () => cycleAccent(i));
                els.beatGrid.appendChild(block);
            }
        }

        function cycleAccent(beatIndex) {
            // Cycle: 2 (normal) -> 4 (accent) -> 0 (muted) -> 2
            const current = state.beatAccents[beatIndex];
            state.beatAccents[beatIndex] = current === 2 ? 4 : current === 4 ? 0 : 2;
            
            const newVal = state.beatAccents[beatIndex];
            const block = els.beatGrid.children[beatIndex];
            const stateEl = block.querySelector('.beat-state');
            
            // Update classes
            block.classList.remove('muted', 'accented', 'normal');
            if (newVal === 0) block.classList.add('muted');
            else if (newVal === 4) block.classList.add('accented');
            else block.classList.add('normal');
            
            // Update label
            stateEl.textContent = newVal === 4 ? 'accent' : newVal === 0 ? 'mute' : '';
        }

        function updateBeatDisplay(beatIndex, fillPercent) {
            const blocks = els.beatGrid.children;
            
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                const fill = block.querySelector('.beat-fill');
                
                if (i < beatIndex) {
                    // Past beats: fully filled
                    fill.style.height = '100%';
                    block.classList.add('active');
                    block.classList.remove('filling');
                } else if (i === beatIndex) {
                    // Current beat: filling
                    fill.style.height = `${fillPercent}%`;
                    block.classList.add('active', 'filling');
                } else {
                    // Future beats: empty
                    fill.style.height = '0%';
                    block.classList.remove('active', 'filling');
                }
            }
        }

        function resetBeatDisplay() {
            const blocks = els.beatGrid.children;
            for (const block of blocks) {
                block.querySelector('.beat-fill').style.height = '0%';
                block.classList.remove('active', 'filling');
            }
        }

        // === Audio ===
        function playClick(time, isAccent, isMuted) {
            if (isMuted) return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            // Frequency: accent = higher pitch
            osc.frequency.value = isAccent ? 1000 : 800;
            
            // Volume
            const vol = state.volume * (isAccent ? 1.0 : 0.6);
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

            osc.start(time);
            osc.stop(time + 0.05);
        }

        function playSubdivClick(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.value = 600;
            const vol = state.volume * 0.3;
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);

            osc.start(time);
            osc.stop(time + 0.03);
        }

        // === Scheduler ===
        const scheduleAhead = 0.1; // seconds
        const lookahead = 25; // ms

        function scheduler() {
            while (state.nextNoteTime < audioCtx.currentTime + scheduleAhead) {
                scheduleNote(state.currentBeat, state.currentSubdiv, state.nextNoteTime);
                advanceNote();
            }
        }

        function scheduleNote(beat, subdiv, time) {
            const isMainBeat = subdiv === 0;
            
            if (isMainBeat) {
                const accent = state.beatAccents[beat];
                const isAccent = accent === 4;
                const isMuted = accent === 0;
                playClick(time, isAccent, isMuted);

                // Schedule visual update
                const delay = Math.max(0, (time - audioCtx.currentTime) * 1000);
                setTimeout(() => {
                    if (state.isPlaying && state.flashEnabled && !isMuted) {
                        flashScreen();
                    }
                }, delay);
            } else {
                // Subdivision click
                playSubdivClick(time);
            }
        }

        function advanceNote() {
            const secondsPerBeat = 60.0 / state.bpm;
            const secondsPerSubdiv = secondsPerBeat / state.subdivision;
            
            state.nextNoteTime += secondsPerSubdiv;
            state.currentSubdiv++;

            if (state.currentSubdiv >= state.subdivision) {
                state.currentSubdiv = 0;
                state.currentBeat++;
                
                if (state.currentBeat >= state.beatsPerMeasure) {
                    state.currentBeat = 0;
                }
            }
        }

        // === Animation ===
        let animationStart = null;

        function animate(timestamp) {
            if (!state.isPlaying) return;

            if (!animationStart) animationStart = timestamp;

            const secondsPerBeat = 60.0 / state.bpm;
            const msPerMeasure = secondsPerBeat * state.beatsPerMeasure * 1000;
            
            const elapsed = timestamp - animationStart;
            const measureProgress = (elapsed % msPerMeasure) / msPerMeasure;
            const exactBeat = measureProgress * state.beatsPerMeasure;
            
            const beatIndex = Math.floor(exactBeat);
            const beatProgress = (exactBeat - beatIndex) * 100;

            updateBeatDisplay(beatIndex, beatProgress);

            state.animationFrame = requestAnimationFrame(animate);
        }

        // === Flash ===
        function flashScreen() {
            document.body.style.background = '#1a1a1a';
            setTimeout(() => {
                document.body.style.background = '';
            }, 80);
        }

        // === Start/Stop ===
        function start() {
            initAudio();
            
            state.isPlaying = true;
            state.currentBeat = 0;
            state.currentSubdiv = 0;
            state.nextNoteTime = audioCtx.currentTime;
            animationStart = null;

            els.playBtn.textContent = 'Stop';
            els.playBtn.classList.add('playing');

            state.schedulerTimer = setInterval(scheduler, lookahead);
            state.animationFrame = requestAnimationFrame(animate);
        }

        function stop() {
            state.isPlaying = false;
            
            clearInterval(state.schedulerTimer);
            cancelAnimationFrame(state.animationFrame);

            els.playBtn.textContent = 'Start';
            els.playBtn.classList.remove('playing');

            resetBeatDisplay();
        }

        function toggle() {
            if (state.isPlaying) {
                stop();
            } else {
                start();
            }
        }

        // === Event Listeners ===
        els.playBtn.addEventListener('click', toggle);

        els.bpmSlider.addEventListener('input', (e) => {
            state.bpm = parseInt(e.target.value);
            els.bpmValue.textContent = state.bpm;
        });

        els.volumeSlider.addEventListener('input', (e) => {
            state.volume = parseInt(e.target.value) / 100;
        });

        // Time signature buttons
        els.timeSigBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                const dir = btn.dataset.dir;
                
                if (target === 'top') {
                    state.beatsPerMeasure = Math.max(1, Math.min(16, 
                        state.beatsPerMeasure + (dir === 'up' ? 1 : -1)));
                    els.timeSigTop.textContent = state.beatsPerMeasure;
                    createBeatGrid();
                    if (state.isPlaying) {
                        state.currentBeat = 0;
                        animationStart = null;
                    }
                } else {
                    const values = [1, 2, 4, 8, 16];
                    const idx = values.indexOf(state.noteValue);
                    const newIdx = Math.max(0, Math.min(values.length - 1,
                        idx + (dir === 'up' ? 1 : -1)));
                    state.noteValue = values[newIdx];
                    els.timeSigBottom.textContent = state.noteValue;
                }
            });
        });

        // Subdivision buttons
        els.subdivBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.subdivBtns.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-checked', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-checked', 'true');
                state.subdivision = parseInt(btn.dataset.subdiv);
            });
        });

        // Flash toggle
        els.flashToggle.addEventListener('click', () => {
            state.flashEnabled = !state.flashEnabled;
            els.flashToggle.classList.toggle('active', state.flashEnabled);
            els.flashToggle.setAttribute('aria-checked', state.flashEnabled);
        });

        els.flashToggle.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                els.flashToggle.click();
            }
        });

        // Keyboard: Space to toggle
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                toggle();
            }
        });

        // === Init ===
        createBeatGrid();
    </script>
</body>
</html>
