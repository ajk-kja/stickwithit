<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MetroGnome | Stick With It</title>
    <meta name="theme-color" content="#000000">
    <style>
        :root {
            --bg: #000;
            --surface: #111;
            --surface-2: #1a1a1a;
            --border: #333;
            --text: #fff;
            --text-muted: #666;
            --accent: #e63946;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header a { color: var(--text-muted); text-decoration: none; font-size: 0.85rem; }
        .header h1 { font-size: 1rem; font-weight: 600; }

        /* Tabs - Segmented Control */
        .tabs {
            display: flex;
            margin: 0 1rem 1rem;
            background: var(--surface);
            border-radius: 10px;
            padding: 4px;
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            padding: 0.6rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--surface-2);
            color: var(--text);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 0 1rem;
            min-height: 0;
        }

        .tab-content.active { display: flex; }

        /* Beat Grid Container - Fixed Height */
        .beat-container {
            background: var(--surface);
            border-radius: 16px;
            padding: 1rem;
            flex-shrink: 0;
            height: 140px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 6px;
        }

        /* Beat Faders */
        .beat-fader {
            flex: 1;
            max-width: 50px;
            height: 100%;
            background: var(--surface-2);
            border-radius: 6px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.15s;
        }

        .beat-fader.level-3 { border-color: var(--text); }

        .beat-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: height 0.1s, background 0.1s;
            border-radius: 0 0 4px 4px;
        }

        .beat-fader.level-0 .beat-fill { height: 0%; background: transparent; }
        .beat-fader.level-1 .beat-fill { height: 33%; background: #444; }
        .beat-fader.level-2 .beat-fill { height: 66%; background: #888; }
        .beat-fader.level-3 .beat-fill { height: 100%; background: var(--accent); border-radius: 4px; }

        .beat-fader.playing .beat-fill { filter: brightness(1.3); }

        .beat-num {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            z-index: 1;
        }

        .beat-fader.level-3 .beat-num,
        .beat-fader.playing .beat-num { color: var(--text); }

        /* Progress overlay */
        .beat-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: rgba(255,255,255,0.3);
            pointer-events: none;
            transition: none;
        }

        /* BPM Section */
        .bpm-section {
            text-align: center;
            padding: 1rem 0;
            flex-shrink: 0;
        }

        .bpm-value {
            font-size: 5rem;
            font-weight: 200;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .bpm-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* BPM Slider */
        .slider-container {
            padding: 0.5rem 0;
            flex-shrink: 0;
        }

        input[type="range"] {
            width: 100%;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--surface);
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 50%;
            margin-top: -12px;
        }

        input[type="range"]::-moz-range-track {
            height: 8px;
            background: var(--surface);
            border-radius: 4px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 50%;
            border: none;
        }

        /* Controls Row */
        .controls-row {
            display: flex;
            gap: 0.75rem;
            flex-shrink: 0;
            padding: 0.5rem 0;
        }

        .settings-btn, .flash-btn {
            flex: 1;
            height: 52px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--text);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.15s;
        }

        .settings-btn:active, .flash-btn:active { background: var(--surface); }

        .flash-btn {
            color: var(--text-muted);
        }

        .flash-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(230,57,70,0.1);
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem 0 1rem;
            flex-shrink: 0;
        }

        .play-btn {
            flex: 2;
            padding: 1.25rem;
            border: none;
            border-radius: 14px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--accent);
            color: var(--bg);
            transition: all 0.15s;
        }

        .play-btn:active { transform: scale(0.98); }
        .play-btn.playing { background: var(--text); }

        .save-btn {
            flex: 1;
            padding: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: var(--text);
        }

        .save-btn:active { background: var(--surface); }

        /* Settings Popup */
        .popup-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .popup-overlay.active { display: flex; }

        .popup {
            background: var(--surface);
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 340px;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .popup-title { font-size: 1.1rem; font-weight: 600; }

        .popup-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--surface-2);
            color: var(--text);
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .popup-section {
            margin-bottom: 1.5rem;
        }

        .popup-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
        }

        /* Time Sig in Popup */
        .time-sig-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .time-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .time-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: var(--surface-2);
            color: var(--text);
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .time-btn:active { background: var(--accent); }

        .time-val {
            font-size: 2.5rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .time-divider {
            font-size: 3rem;
            font-weight: 200;
            color: var(--text-muted);
        }

        /* Subdivision Notes */
        .subdiv-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .subdiv-opt {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px;
            transition: all 0.15s;
        }

        .subdiv-opt.active {
            border-color: var(--accent);
            background: rgba(230,57,70,0.15);
        }

        .subdiv-notes {
            display: flex;
            gap: 2px;
            font-size: 1.2rem;
        }

        .subdiv-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .subdiv-opt.active .subdiv-label { color: var(--accent); }

        /* Playlist Tab */
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            flex-shrink: 0;
        }

        .playlist-title { font-weight: 600; }

        .edit-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .edit-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .playlist-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .playlist-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
            font-size: 0.9rem;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .playlist-item:active { background: var(--surface-2); }

        .pl-info { flex: 1; min-width: 0; }
        .pl-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pl-details { font-size: 0.8rem; color: var(--text-muted); }
        .pl-bpm { font-size: 1.4rem; font-weight: 300; color: var(--accent); }

        .pl-actions { display: none; gap: 0.5rem; }
        .editing .pl-actions { display: flex; }
        .editing .pl-bpm { display: none; }

        .pl-action {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        .pl-action.rename { background: var(--surface-2); color: var(--text); }
        .pl-action.delete { background: rgba(230,57,70,0.2); color: var(--accent); }

        .add-item {
            display: none;
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .editing .add-item { display: block; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 300px;
        }

        .modal-title { font-weight: 600; margin-bottom: 1rem; }

        .modal-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-input:focus { outline: none; border-color: var(--accent); }

        .modal-btns { display: flex; gap: 0.75rem; }

        .modal-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.cancel { background: var(--surface-2); color: var(--text); }
        .modal-btn.confirm { background: var(--accent); color: var(--bg); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--surface);
            padding: 0.875rem 1.25rem;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 50;
            border: 1px solid var(--border);
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        @media (min-width: 500px) {
            .tab-content, .tabs { max-width: 400px; margin-left: auto; margin-right: auto; }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <a href="/">‚Üê Home</a>
        <h1>MetroGnome</h1>
        <div style="width:50px"></div>
    </header>

    <nav class="tabs">
        <button class="tab active" data-tab="metro">Metronome</button>
        <button class="tab" data-tab="playlist">Playlist</button>
    </nav>

    <!-- Metronome Tab -->
    <div class="tab-content active" id="metro-tab">
        <div class="beat-container" id="beatContainer"></div>

        <div class="bpm-section">
            <div class="bpm-value" id="bpmValue">120</div>
            <div class="bpm-label">BPM</div>
        </div>

        <div class="slider-container">
            <input type="range" id="bpmSlider" min="30" max="300" value="120">
        </div>

        <div class="controls-row">
            <button class="settings-btn" id="settingsBtn">‚öôÔ∏è Settings</button>
            <button class="flash-btn" id="flashBtn">üí° Flash</button>
        </div>

        <div class="btn-row">
            <button class="play-btn" id="playBtn">Start</button>
            <button class="save-btn" id="saveBtn">Save</button>
        </div>
    </div>

    <!-- Playlist Tab -->
    <div class="tab-content" id="playlist-tab">
        <div class="playlist-header">
            <span class="playlist-title">Saved Tempos</span>
            <button class="edit-btn" id="editBtn">Edit</button>
        </div>
        <div class="playlist-list" id="playlistList">
            <div class="playlist-empty">No saved tempos yet</div>
        </div>
    </div>
</div>

<!-- Settings Popup -->
<div class="popup-overlay" id="settingsPopup">
    <div class="popup">
        <div class="popup-header">
            <span class="popup-title">Settings</span>
            <button class="popup-close" id="popupClose">√ó</button>
        </div>

        <div class="popup-section">
            <div class="popup-label">Time Signature</div>
            <div class="time-sig-row">
                <div class="time-picker">
                    <button class="time-btn" data-t="top" data-d="up">+</button>
                    <div class="time-val" id="tsTop">4</div>
                    <button class="time-btn" data-t="top" data-d="down">‚àí</button>
                </div>
                <div class="time-divider">/</div>
                <div class="time-picker">
                    <button class="time-btn" data-t="bot" data-d="up">+</button>
                    <div class="time-val" id="tsBot">4</div>
                    <button class="time-btn" data-t="bot" data-d="down">‚àí</button>
                </div>
            </div>
        </div>

        <div class="popup-section">
            <div class="popup-label">Subdivision</div>
            <div class="subdiv-options" id="subdivOptions">
                <button class="subdiv-opt active" data-sub="1">
                    <div class="subdiv-notes">‚ô©</div>
                    <div class="subdiv-label">1</div>
                </button>
                <button class="subdiv-opt" data-sub="2">
                    <div class="subdiv-notes">‚ô™‚ô™</div>
                    <div class="subdiv-label">2</div>
                </button>
                <button class="subdiv-opt" data-sub="3">
                    <div class="subdiv-notes">‚ô™‚ô™‚ô™</div>
                    <div class="subdiv-label">3</div>
                </button>
                <button class="subdiv-opt" data-sub="4">
                    <div class="subdiv-notes">‚ô¨‚ô¨</div>
                    <div class="subdiv-label">4</div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal-overlay" id="renameModal">
    <div class="modal">
        <div class="modal-title">Rename</div>
        <input type="text" class="modal-input" id="renameInput" placeholder="Name...">
        <div class="modal-btns">
            <button class="modal-btn cancel" id="renameCancel">Cancel</button>
            <button class="modal-btn confirm" id="renameConfirm">Save</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">Saved!</div>

<script>
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

const state = {
    playing: false,
    bpm: 120,
    beats: 4,
    noteVal: 4,
    subdiv: 1,
    flash: false,
    // 4 levels: 0=off, 1=quiet, 2=medium, 3=accent
    levels: [3, 2, 2, 2],
    curBeat: 0,
    curSub: 0,
    nextTime: 0,
    timer: null,
    animFrame: null
};

let playlist = JSON.parse(localStorage.getItem('mg-playlist') || '[]');
let editing = false;
let renameIdx = null;

const $ = id => document.getElementById(id);

const beatContainer = $('beatContainer');
const bpmValue = $('bpmValue');
const bpmSlider = $('bpmSlider');
const playBtn = $('playBtn');
const saveBtn = $('saveBtn');
const settingsBtn = $('settingsBtn');
const settingsPopup = $('settingsPopup');
const popupClose = $('popupClose');
const flashBtn = $('flashBtn');
const tsTop = $('tsTop');
const tsBot = $('tsBot');
const subdivOptions = $('subdivOptions');
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
const playlistList = $('playlistList');
const editBtn = $('editBtn');
const renameModal = $('renameModal');
const renameInput = $('renameInput');
const toast = $('toast');

// Audio
function initAudio() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playClick(time, level) {
    if (level === 0) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    const freqs = [0, 600, 800, 1000];
    const vols = [0, 0.4, 0.7, 1.0];
    
    osc.frequency.value = freqs[level];
    gain.gain.setValueAtTime(vols[level], time);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
    osc.start(time);
    osc.stop(time + 0.05);
}

function playSubClick(time) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 500;
    gain.gain.setValueAtTime(0.3, time);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
    osc.start(time);
    osc.stop(time + 0.03);
}

// Beat Grid
function buildBeats() {
    beatContainer.innerHTML = '';
    const old = [...state.levels];
    state.levels = [];
    for (let i = 0; i < state.beats; i++) {
        state.levels[i] = i < old.length ? old[i] : (i === 0 ? 3 : 2);
    }
    
    for (let i = 0; i < state.beats; i++) {
        const el = document.createElement('div');
        el.className = `beat-fader level-${state.levels[i]}`;
        el.dataset.idx = i;
        el.innerHTML = `
            <div class="beat-fill"></div>
            <div class="beat-progress"></div>
            <div class="beat-num">${i + 1}</div>
        `;
        el.addEventListener('click', () => cycleLevel(i));
        beatContainer.appendChild(el);
    }
}

function cycleLevel(i) {
    // 2 -> 3 -> 0 -> 1 -> 2
    const map = {0: 1, 1: 2, 2: 3, 3: 0};
    state.levels[i] = map[state.levels[i]];
    const el = beatContainer.children[i];
    el.className = `beat-fader level-${state.levels[i]}`;
}

function updateBeatVisuals(beatIdx, progress) {
    const faders = beatContainer.children;
    for (let i = 0; i < faders.length; i++) {
        const f = faders[i];
        const prog = f.querySelector('.beat-progress');
        f.classList.toggle('playing', i === beatIdx);
        prog.style.height = i === beatIdx ? `${progress}%` : '0%';
    }
}

function resetVisuals() {
    const faders = beatContainer.children;
    for (const f of faders) {
        f.classList.remove('playing');
        f.querySelector('.beat-progress').style.height = '0%';
    }
}

// Scheduler
const AHEAD = 0.1, LOOK = 25;

function scheduler() {
    while (state.nextTime < audioCtx.currentTime + AHEAD) {
        scheduleNote();
        advance();
    }
}

function scheduleNote() {
    if (state.curSub === 0) {
        const lvl = state.levels[state.curBeat];
        playClick(state.nextTime, lvl);
        const delay = Math.max(0, (state.nextTime - audioCtx.currentTime) * 1000);
        setTimeout(() => {
            if (state.playing && state.flash && lvl > 0) flash();
        }, delay);
    } else {
        playSubClick(state.nextTime);
    }
}

function advance() {
    const secPerBeat = 60 / state.bpm;
    state.nextTime += secPerBeat / state.subdiv;
    state.curSub++;
    if (state.curSub >= state.subdiv) {
        state.curSub = 0;
        state.curBeat = (state.curBeat + 1) % state.beats;
    }
}

let animStart = null;

function animate(ts) {
    if (!state.playing) return;
    if (!animStart) animStart = ts;
    const secPerBeat = 60 / state.bpm;
    const msPerMeasure = secPerBeat * state.beats * 1000;
    const elapsed = ts - animStart;
    const prog = (elapsed % msPerMeasure) / msPerMeasure;
    const exact = prog * state.beats;
    const idx = Math.floor(exact);
    const pct = (exact - idx) * 100;
    updateBeatVisuals(idx, pct);
    state.animFrame = requestAnimationFrame(animate);
}

function flash() {
    document.body.style.background = '#1a1a1a';
    setTimeout(() => document.body.style.background = '', 60);
}

function start() {
    initAudio();
    state.playing = true;
    state.curBeat = 0;
    state.curSub = 0;
    state.nextTime = audioCtx.currentTime;
    animStart = null;
    playBtn.textContent = 'Stop';
    playBtn.classList.add('playing');
    state.timer = setInterval(scheduler, LOOK);
    state.animFrame = requestAnimationFrame(animate);
}

function stop() {
    state.playing = false;
    clearInterval(state.timer);
    cancelAnimationFrame(state.animFrame);
    playBtn.textContent = 'Start';
    playBtn.classList.remove('playing');
    resetVisuals();
}

function toggle() { state.playing ? stop() : start(); }

// Playlist
function saveCurrent() {
    playlist.push({
        name: `${state.bpm} BPM - ${state.beats}/${state.noteVal}`,
        bpm: state.bpm,
        beats: state.beats,
        noteVal: state.noteVal,
        subdiv: state.subdiv,
        levels: [...state.levels]
    });
    localStorage.setItem('mg-playlist', JSON.stringify(playlist));
    showToast('Saved!');
}

function loadItem(i) {
    const p = playlist[i];
    state.bpm = p.bpm;
    state.beats = p.beats;
    state.noteVal = p.noteVal;
    state.subdiv = p.subdiv;
    state.levels = [...p.levels];
    bpmValue.textContent = state.bpm;
    bpmSlider.value = state.bpm;
    tsTop.textContent = state.beats;
    tsBot.textContent = state.noteVal;
    subdivOptions.querySelectorAll('.subdiv-opt').forEach(o => {
        o.classList.toggle('active', +o.dataset.sub === state.subdiv);
    });
    buildBeats();
    tabs[0].click();
    showToast('Loaded!');
}

function deleteItem(i) {
    playlist.splice(i, 1);
    localStorage.setItem('mg-playlist', JSON.stringify(playlist));
    renderPlaylist();
}

function renameItem(i, name) {
    playlist[i].name = name;
    localStorage.setItem('mg-playlist', JSON.stringify(playlist));
    renderPlaylist();
}

function renderPlaylist() {
    playlistList.innerHTML = '';
    playlistList.classList.toggle('editing', editing);
    
    if (!playlist.length) {
        playlistList.innerHTML = '<div class="playlist-empty">No saved tempos yet</div>';
        return;
    }
    
    playlist.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'playlist-item';
        el.innerHTML = `
            <div class="pl-info">
                <div class="pl-name">${p.name}</div>
                <div class="pl-details">${p.beats}/${p.noteVal} ‚Ä¢ Sub ${p.subdiv}</div>
            </div>
            <div class="pl-bpm">${p.bpm}</div>
            <div class="pl-actions">
                <button class="pl-action rename" data-i="${i}">‚úèÔ∏è</button>
                <button class="pl-action delete" data-i="${i}">üóëÔ∏è</button>
            </div>
        `;
        if (!editing) el.addEventListener('click', () => loadItem(i));
        playlistList.appendChild(el);
    });
    
    const addBtn = document.createElement('button');
    addBtn.className = 'add-item';
    addBtn.textContent = '+ Add Current';
    addBtn.addEventListener('click', () => { saveCurrent(); renderPlaylist(); });
    playlistList.appendChild(addBtn);
    
    playlistList.querySelectorAll('.pl-action.rename').forEach(b => {
        b.addEventListener('click', e => {
            e.stopPropagation();
            renameIdx = +b.dataset.i;
            renameInput.value = playlist[renameIdx].name;
            renameModal.classList.add('active');
            renameInput.focus();
        });
    });
    
    playlistList.querySelectorAll('.pl-action.delete').forEach(b => {
        b.addEventListener('click', e => {
            e.stopPropagation();
            deleteItem(+b.dataset.i);
        });
    });
}

function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1500);
}

// Events
playBtn.addEventListener('click', toggle);
saveBtn.addEventListener('click', saveCurrent);

bpmSlider.addEventListener('input', e => {
    state.bpm = +e.target.value;
    bpmValue.textContent = state.bpm;
});

settingsBtn.addEventListener('click', () => settingsPopup.classList.add('active'));
popupClose.addEventListener('click', () => settingsPopup.classList.remove('active'));
settingsPopup.addEventListener('click', e => {
    if (e.target === settingsPopup) settingsPopup.classList.remove('active');
});

flashBtn.addEventListener('click', () => {
    state.flash = !state.flash;
    flashBtn.classList.toggle('active', state.flash);
});

document.querySelectorAll('.time-btn').forEach(b => {
    b.addEventListener('click', () => {
        const t = b.dataset.t, d = b.dataset.d;
        if (t === 'top') {
            state.beats = Math.max(1, Math.min(16, state.beats + (d === 'up' ? 1 : -1)));
            tsTop.textContent = state.beats;
            buildBeats();
            if (state.playing) { state.curBeat = 0; animStart = null; }
        } else {
            const vals = [1, 2, 4, 8, 16];
            const idx = vals.indexOf(state.noteVal);
            state.noteVal = vals[Math.max(0, Math.min(4, idx + (d === 'up' ? 1 : -1)))];
            tsBot.textContent = state.noteVal;
        }
    });
});

subdivOptions.querySelectorAll('.subdiv-opt').forEach(o => {
    o.addEventListener('click', () => {
        subdivOptions.querySelectorAll('.subdiv-opt').forEach(x => x.classList.remove('active'));
        o.classList.add('active');
        state.subdiv = +o.dataset.sub;
    });
});

tabs.forEach(t => {
    t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.toggle('active', x === t));
        tabContents.forEach(c => c.classList.toggle('active', c.id === `${t.dataset.tab}-tab`));
        if (t.dataset.tab === 'playlist') renderPlaylist();
    });
});

editBtn.addEventListener('click', () => {
    editing = !editing;
    editBtn.classList.toggle('active', editing);
    editBtn.textContent = editing ? 'Done' : 'Edit';
    renderPlaylist();
});

$('renameCancel').addEventListener('click', () => {
    renameModal.classList.remove('active');
    renameIdx = null;
});

$('renameConfirm').addEventListener('click', () => {
    if (renameIdx !== null && renameInput.value.trim()) {
        renameItem(renameIdx, renameInput.value.trim());
    }
    renameModal.classList.remove('active');
    renameIdx = null;
});

renameInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') $('renameConfirm').click();
    if (e.key === 'Escape') $('renameCancel').click();
});

document.addEventListener('keydown', e => {
    if (e.code === 'Space' && !['BUTTON', 'INPUT'].includes(e.target.tagName)) {
        e.preventDefault();
        toggle();
    }
});

// Init
buildBeats();
</script>
</body>
</html>
