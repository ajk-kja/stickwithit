<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MetroGnome | Stick With It</title>
    <meta name="description" content="A clean, accessible metronome for drummers">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/assets/StickWithItBlack.png">
    <style>
        :root {
            --bg: #000;
            --surface: #111;
            --surface-2: #1a1a1a;
            --border: #333;
            --text: #fff;
            --text-muted: #888;
            --accent: #e63946;
            --accent-dim: rgba(230, 57, 70, 0.3);
            --beat-inactive: #222;
            --beat-fill: #e63946;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        /* Header */
        .header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .header a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .tab.active {
            color: var(--text);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 2px;
            background: var(--accent);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Main Container */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Beat Display */
        .beat-display {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.25rem;
            flex-shrink: 0;
        }

        .beat-grid {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            max-width: 100%;
        }

        .beat-block {
            aspect-ratio: 1;
            min-height: 40px;
            max-height: 60px;
            background: var(--beat-inactive);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.15s, box-shadow 0.15s;
            border: 2px solid transparent;
        }

        .beat-block:active {
            transform: scale(0.95);
        }

        .beat-block.accented {
            border-color: var(--text);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .beat-block.normal {
            border-color: var(--border);
        }

        .beat-block.muted {
            opacity: 0.5;
            border-color: transparent;
        }

        .beat-block.muted::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 45%, var(--text-muted) 45%, var(--text-muted) 55%, transparent 55%);
            opacity: 0.3;
            pointer-events: none;
            z-index: 2;
        }

        .beat-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: var(--accent);
            transition: height 0.05s linear;
            border-radius: 0 0 6px 6px;
        }

        .beat-block.filling .beat-fill {
            border-radius: 6px;
        }

        .beat-block.muted .beat-fill {
            background: var(--text-muted);
        }

        .beat-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            z-index: 1;
            transition: color 0.1s;
        }

        .beat-block.accented .beat-number {
            color: var(--accent);
        }

        .beat-block.active .beat-number {
            color: var(--text);
        }

        .beat-state {
            position: absolute;
            bottom: 3px;
            left: 0;
            right: 0;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            color: var(--text-muted);
            opacity: 0.7;
            z-index: 1;
        }

        .beat-block.accented .beat-state {
            color: var(--accent);
        }

        /* BPM Display */
        .bpm-section {
            text-align: center;
            flex-shrink: 0;
        }

        .bpm-value {
            font-size: 4.5rem;
            font-weight: 200;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .bpm-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0.25rem;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-row {
            display: flex;
            gap: 1rem;
            align-items: stretch;
        }

        .control-group {
            flex: 1;
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
        }

        .control-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
            display: block;
        }

        /* Time Signature */
        .time-sig {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .time-sig-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-sig-value {
            font-size: 2rem;
            font-weight: 600;
            width: 3rem;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        .time-sig-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--surface-2);
            color: var(--text);
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .time-sig-btn:hover {
            background: var(--border);
        }

        .time-sig-btn:active {
            background: var(--accent);
        }

        .time-sig-divider {
            font-size: 2.5rem;
            font-weight: 200;
            color: var(--text-muted);
        }

        /* Subdivision */
        .subdivision-picker {
            display: flex;
            gap: 0.5rem;
        }

        .subdiv-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .subdiv-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
            font-weight: 600;
        }

        /* BPM Slider */
        .bpm-slider-container {
            padding: 0.5rem 0;
        }

        input[type="range"] {
            width: 100%;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            margin-top: -10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-track {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Volume */
        .volume-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .volume-icon {
            font-size: 1.25rem;
        }

        .volume-slider {
            flex: 1;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 0.75rem;
        }

        .play-btn {
            flex: 2;
            padding: 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--accent);
            color: var(--bg);
        }

        .play-btn:hover {
            filter: brightness(1.1);
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        .play-btn.playing {
            background: var(--text);
            color: var(--bg);
        }

        .save-btn {
            flex: 1;
            padding: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            background: transparent;
            color: var(--text);
        }

        .save-btn:hover {
            border-color: var(--text);
        }

        .save-btn:active {
            background: var(--surface);
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
        }

        .toggle-label {
            font-size: 0.9rem;
        }

        .toggle {
            width: 52px;
            height: 32px;
            background: var(--surface-2);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 26px;
            height: 26px;
            background: var(--text);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle.active .toggle-knob {
            transform: translateX(20px);
        }

        /* === Playlist Tab === */
        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .playlist-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .edit-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .edit-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .playlist-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .playlist-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 3rem 1rem;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .playlist-item:hover {
            background: var(--surface-2);
        }

        .playlist-item:active {
            transform: scale(0.98);
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-details {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .playlist-item-bpm {
            font-size: 1.5rem;
            font-weight: 300;
            color: var(--accent);
            font-variant-numeric: tabular-nums;
        }

        .playlist-item-actions {
            display: none;
            gap: 0.5rem;
        }

        .editing .playlist-item-actions {
            display: flex;
        }

        .editing .playlist-item-bpm {
            display: none;
        }

        .item-action-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.15s;
        }

        .item-action-btn.rename {
            background: var(--surface-2);
            color: var(--text);
        }

        .item-action-btn.delete {
            background: rgba(230, 57, 70, 0.2);
            color: var(--accent);
        }

        .item-action-btn:hover {
            filter: brightness(1.2);
        }

        .add-btn {
            display: none;
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 0.5rem;
        }

        .editing .add-btn {
            display: block;
        }

        .add-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 320px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .modal-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-btns {
            display: flex;
            gap: 0.75rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: var(--surface-2);
            color: var(--text);
        }

        .modal-btn.confirm {
            background: var(--accent);
            color: var(--bg);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-size: 0.95rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 50;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        @media (min-width: 768px) {
            .main {
                max-width: 500px;
                margin: 0 auto;
            }
            .playlist-list {
                max-width: 500px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" aria-label="Back to Stick With It">‚Üê Home</a>
        <h1>MetroGnome</h1>
        <div style="width: 50px;"></div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
        <button class="tab active" data-tab="metronome">Metronome</button>
        <button class="tab" data-tab="playlist">Playlist</button>
    </nav>

    <!-- Metronome Tab -->
    <div class="tab-content active" id="metronome-tab">
        <main class="main">
            <section class="beat-display" aria-label="Beat visualization">
                <div class="beat-grid" id="beatGrid" role="group" aria-label="Beat indicators"></div>
            </section>

            <section class="bpm-section">
                <div class="bpm-value" id="bpmValue" aria-live="polite">120</div>
                <div class="bpm-label">BPM</div>
            </section>

            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label class="control-label">Time Signature</label>
                        <div class="time-sig">
                            <div class="time-sig-picker">
                                <button class="time-sig-btn" data-target="top" data-dir="up" aria-label="Increase beats">+</button>
                                <div class="time-sig-value" id="timeSigTop">4</div>
                                <button class="time-sig-btn" data-target="top" data-dir="down" aria-label="Decrease beats">‚àí</button>
                            </div>
                            <div class="time-sig-divider">/</div>
                            <div class="time-sig-picker">
                                <button class="time-sig-btn" data-target="bottom" data-dir="up" aria-label="Increase note value">+</button>
                                <div class="time-sig-value" id="timeSigBottom">4</div>
                                <button class="time-sig-btn" data-target="bottom" data-dir="down" aria-label="Decrease note value">‚àí</button>
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Subdivision</label>
                        <div class="subdivision-picker" role="radiogroup" aria-label="Subdivision selection">
                            <button class="subdiv-btn active" data-subdiv="1" role="radio" aria-checked="true">1</button>
                            <button class="subdiv-btn" data-subdiv="2" role="radio" aria-checked="false">2</button>
                            <button class="subdiv-btn" data-subdiv="3" role="radio" aria-checked="false">3</button>
                            <button class="subdiv-btn" data-subdiv="4" role="radio" aria-checked="false">4</button>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="bpmSlider">Tempo</label>
                    <div class="bpm-slider-container">
                        <input type="range" id="bpmSlider" min="30" max="300" value="120" aria-label="BPM">
                    </div>
                    <div class="slider-labels">
                        <span>30</span>
                        <span>300</span>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Volume</label>
                    <div class="volume-row">
                        <span class="volume-icon">üîà</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="80" aria-label="Volume">
                        <span class="volume-icon">üîä</span>
                    </div>
                </div>

                <div class="control-group">
                    <div class="toggle-row">
                        <span class="toggle-label">Flash on Beat</span>
                        <div class="toggle" id="flashToggle" role="switch" aria-checked="false" tabindex="0">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="play-btn" id="playBtn" aria-label="Start metronome">Start</button>
                    <button class="save-btn" id="saveBtn">Save</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Playlist Tab -->
    <div class="tab-content" id="playlist-tab">
        <div class="playlist-header">
            <span class="playlist-title">Saved Tempos</span>
            <button class="edit-btn" id="editBtn">Edit</button>
        </div>
        <div class="playlist-list" id="playlistList">
            <div class="playlist-empty" id="playlistEmpty">
                No saved tempos yet.<br>Save one from the Metronome tab!
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-title">Rename Tempo</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="Enter name...">
            <div class="modal-btns">
                <button class="modal-btn cancel" id="renameCancel">Cancel</button>
                <button class="modal-btn confirm" id="renameConfirm">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">Saved!</div>

    <script>
        // === Audio Context ===
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // === State ===
        const state = {
            isPlaying: false,
            bpm: 120,
            beatsPerMeasure: 4,
            noteValue: 4,
            subdivision: 1,
            volume: 0.8,
            flashEnabled: false,
            currentBeat: 0,
            currentSubdiv: 0,
            beatAccents: [4, 2, 2, 2],
            nextNoteTime: 0,
            schedulerTimer: null,
            animationFrame: null
        };

        // === Playlist State ===
        let playlist = JSON.parse(localStorage.getItem('metrognome-playlist') || '[]');
        let isEditing = false;
        let renameIndex = null;

        // === DOM Elements ===
        const els = {
            beatGrid: document.getElementById('beatGrid'),
            bpmValue: document.getElementById('bpmValue'),
            bpmSlider: document.getElementById('bpmSlider'),
            volumeSlider: document.getElementById('volumeSlider'),
            timeSigTop: document.getElementById('timeSigTop'),
            timeSigBottom: document.getElementById('timeSigBottom'),
            playBtn: document.getElementById('playBtn'),
            saveBtn: document.getElementById('saveBtn'),
            flashToggle: document.getElementById('flashToggle'),
            subdivBtns: document.querySelectorAll('.subdiv-btn'),
            timeSigBtns: document.querySelectorAll('.time-sig-btn'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            playlistList: document.getElementById('playlistList'),
            playlistEmpty: document.getElementById('playlistEmpty'),
            editBtn: document.getElementById('editBtn'),
            renameModal: document.getElementById('renameModal'),
            renameInput: document.getElementById('renameInput'),
            renameCancel: document.getElementById('renameCancel'),
            renameConfirm: document.getElementById('renameConfirm'),
            toast: document.getElementById('toast')
        };

        // === Tabs ===
        els.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                els.tabs.forEach(t => t.classList.toggle('active', t === tab));
                els.tabContents.forEach(c => c.classList.toggle('active', c.id === `${target}-tab`));
                if (target === 'playlist') renderPlaylist();
            });
        });

        // === Beat Grid ===
        function createBeatGrid() {
            els.beatGrid.innerHTML = '';
            const cols = state.beatsPerMeasure <= 4 ? state.beatsPerMeasure 
                       : state.beatsPerMeasure <= 8 ? 4 
                       : Math.min(4, Math.ceil(state.beatsPerMeasure / 4));
            els.beatGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            const oldAccents = [...state.beatAccents];
            state.beatAccents = [];
            for (let i = 0; i < state.beatsPerMeasure; i++) {
                state.beatAccents[i] = i < oldAccents.length ? oldAccents[i] : (i === 0 ? 4 : 2);
            }

            for (let i = 0; i < state.beatsPerMeasure; i++) {
                const block = document.createElement('div');
                block.className = 'beat-block';
                block.dataset.beat = i;
                
                const accent = state.beatAccents[i];
                if (accent === 0) block.classList.add('muted');
                else if (accent === 4) block.classList.add('accented');
                else block.classList.add('normal');

                const stateLabel = accent === 4 ? 'accent' : accent === 0 ? 'mute' : '';

                block.innerHTML = `
                    <div class="beat-fill"></div>
                    <span class="beat-number">${i + 1}</span>
                    <span class="beat-state">${stateLabel}</span>
                `;

                block.addEventListener('click', () => cycleAccent(i));
                els.beatGrid.appendChild(block);
            }
        }

        function cycleAccent(beatIndex) {
            const current = state.beatAccents[beatIndex];
            state.beatAccents[beatIndex] = current === 2 ? 4 : current === 4 ? 0 : 2;
            
            const newVal = state.beatAccents[beatIndex];
            const block = els.beatGrid.children[beatIndex];
            const stateEl = block.querySelector('.beat-state');
            
            block.classList.remove('muted', 'accented', 'normal');
            if (newVal === 0) block.classList.add('muted');
            else if (newVal === 4) block.classList.add('accented');
            else block.classList.add('normal');
            
            stateEl.textContent = newVal === 4 ? 'accent' : newVal === 0 ? 'mute' : '';
        }

        function updateBeatDisplay(beatIndex, fillPercent) {
            const blocks = els.beatGrid.children;
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                const fill = block.querySelector('.beat-fill');
                if (i < beatIndex) {
                    fill.style.height = '100%';
                    block.classList.add('active');
                    block.classList.remove('filling');
                } else if (i === beatIndex) {
                    fill.style.height = `${fillPercent}%`;
                    block.classList.add('active', 'filling');
                } else {
                    fill.style.height = '0%';
                    block.classList.remove('active', 'filling');
                }
            }
        }

        function resetBeatDisplay() {
            const blocks = els.beatGrid.children;
            for (const block of blocks) {
                block.querySelector('.beat-fill').style.height = '0%';
                block.classList.remove('active', 'filling');
            }
        }

        // === Audio ===
        function playClick(time, isAccent, isMuted) {
            if (isMuted) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = isAccent ? 1000 : 800;
            const vol = state.volume * (isAccent ? 1.0 : 0.6);
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            osc.start(time);
            osc.stop(time + 0.05);
        }

        function playSubdivClick(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 600;
            const vol = state.volume * 0.3;
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
            osc.start(time);
            osc.stop(time + 0.03);
        }

        // === Scheduler ===
        const scheduleAhead = 0.1;
        const lookahead = 25;

        function scheduler() {
            while (state.nextNoteTime < audioCtx.currentTime + scheduleAhead) {
                scheduleNote(state.currentBeat, state.currentSubdiv, state.nextNoteTime);
                advanceNote();
            }
        }

        function scheduleNote(beat, subdiv, time) {
            const isMainBeat = subdiv === 0;
            if (isMainBeat) {
                const accent = state.beatAccents[beat];
                playClick(time, accent === 4, accent === 0);
                const delay = Math.max(0, (time - audioCtx.currentTime) * 1000);
                setTimeout(() => {
                    if (state.isPlaying && state.flashEnabled && accent !== 0) flashScreen();
                }, delay);
            } else {
                playSubdivClick(time);
            }
        }

        function advanceNote() {
            const secondsPerBeat = 60.0 / state.bpm;
            const secondsPerSubdiv = secondsPerBeat / state.subdivision;
            state.nextNoteTime += secondsPerSubdiv;
            state.currentSubdiv++;
            if (state.currentSubdiv >= state.subdivision) {
                state.currentSubdiv = 0;
                state.currentBeat++;
                if (state.currentBeat >= state.beatsPerMeasure) state.currentBeat = 0;
            }
        }

        // === Animation ===
        let animationStart = null;

        function animate(timestamp) {
            if (!state.isPlaying) return;
            if (!animationStart) animationStart = timestamp;
            const secondsPerBeat = 60.0 / state.bpm;
            const msPerMeasure = secondsPerBeat * state.beatsPerMeasure * 1000;
            const elapsed = timestamp - animationStart;
            const measureProgress = (elapsed % msPerMeasure) / msPerMeasure;
            const exactBeat = measureProgress * state.beatsPerMeasure;
            const beatIndex = Math.floor(exactBeat);
            const beatProgress = (exactBeat - beatIndex) * 100;
            updateBeatDisplay(beatIndex, beatProgress);
            state.animationFrame = requestAnimationFrame(animate);
        }

        function flashScreen() {
            document.body.style.background = '#1a1a1a';
            setTimeout(() => { document.body.style.background = ''; }, 80);
        }

        // === Start/Stop ===
        function start() {
            initAudio();
            state.isPlaying = true;
            state.currentBeat = 0;
            state.currentSubdiv = 0;
            state.nextNoteTime = audioCtx.currentTime;
            animationStart = null;
            els.playBtn.textContent = 'Stop';
            els.playBtn.classList.add('playing');
            state.schedulerTimer = setInterval(scheduler, lookahead);
            state.animationFrame = requestAnimationFrame(animate);
        }

        function stop() {
            state.isPlaying = false;
            clearInterval(state.schedulerTimer);
            cancelAnimationFrame(state.animationFrame);
            els.playBtn.textContent = 'Start';
            els.playBtn.classList.remove('playing');
            resetBeatDisplay();
        }

        function toggle() {
            state.isPlaying ? stop() : start();
        }

        // === Save & Playlist ===
        function saveToPlaylist() {
            const entry = {
                name: `${state.bpm} BPM - ${state.beatsPerMeasure}/${state.noteValue}`,
                bpm: state.bpm,
                beatsPerMeasure: state.beatsPerMeasure,
                noteValue: state.noteValue,
                subdivision: state.subdivision,
                beatAccents: [...state.beatAccents]
            };
            playlist.push(entry);
            localStorage.setItem('metrognome-playlist', JSON.stringify(playlist));
            showToast('Saved to playlist!');
        }

        function loadFromPlaylist(index) {
            const entry = playlist[index];
            state.bpm = entry.bpm;
            state.beatsPerMeasure = entry.beatsPerMeasure;
            state.noteValue = entry.noteValue;
            state.subdivision = entry.subdivision;
            state.beatAccents = [...entry.beatAccents];

            els.bpmValue.textContent = state.bpm;
            els.bpmSlider.value = state.bpm;
            els.timeSigTop.textContent = state.beatsPerMeasure;
            els.timeSigBottom.textContent = state.noteValue;
            
            els.subdivBtns.forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.subdiv) === state.subdivision);
            });

            createBeatGrid();

            // Switch to metronome tab
            els.tabs[0].click();
            showToast('Loaded!');
        }

        function deleteFromPlaylist(index) {
            playlist.splice(index, 1);
            localStorage.setItem('metrognome-playlist', JSON.stringify(playlist));
            renderPlaylist();
        }

        function renameInPlaylist(index, newName) {
            playlist[index].name = newName;
            localStorage.setItem('metrognome-playlist', JSON.stringify(playlist));
            renderPlaylist();
        }

        function renderPlaylist() {
            els.playlistList.innerHTML = '';
            els.playlistList.classList.toggle('editing', isEditing);

            if (playlist.length === 0) {
                els.playlistList.innerHTML = `
                    <div class="playlist-empty">No saved tempos yet.<br>Save one from the Metronome tab!</div>
                `;
                return;
            }

            playlist.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `
                    <div class="playlist-item-info">
                        <div class="playlist-item-name">${entry.name}</div>
                        <div class="playlist-item-details">${entry.beatsPerMeasure}/${entry.noteValue} ‚Ä¢ Subdiv ${entry.subdivision}</div>
                    </div>
                    <div class="playlist-item-bpm">${entry.bpm}</div>
                    <div class="playlist-item-actions">
                        <button class="item-action-btn rename" data-index="${index}" aria-label="Rename">‚úèÔ∏è</button>
                        <button class="item-action-btn delete" data-index="${index}" aria-label="Delete">üóëÔ∏è</button>
                    </div>
                `;

                if (!isEditing) {
                    item.addEventListener('click', () => loadFromPlaylist(index));
                }

                els.playlistList.appendChild(item);
            });

            // Add button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.textContent = '+ Add Current Settings';
            addBtn.addEventListener('click', () => {
                saveToPlaylist();
                renderPlaylist();
            });
            els.playlistList.appendChild(addBtn);

            // Attach action listeners
            els.playlistList.querySelectorAll('.item-action-btn.rename').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    renameIndex = parseInt(btn.dataset.index);
                    els.renameInput.value = playlist[renameIndex].name;
                    els.renameModal.classList.add('active');
                    els.renameInput.focus();
                });
            });

            els.playlistList.querySelectorAll('.item-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFromPlaylist(parseInt(btn.dataset.index));
                });
            });
        }

        function showToast(message) {
            els.toast.textContent = message;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 2000);
        }

        // === Event Listeners ===
        els.playBtn.addEventListener('click', toggle);
        els.saveBtn.addEventListener('click', saveToPlaylist);

        els.editBtn.addEventListener('click', () => {
            isEditing = !isEditing;
            els.editBtn.classList.toggle('active', isEditing);
            els.editBtn.textContent = isEditing ? 'Done' : 'Edit';
            renderPlaylist();
        });

        els.renameCancel.addEventListener('click', () => {
            els.renameModal.classList.remove('active');
            renameIndex = null;
        });

        els.renameConfirm.addEventListener('click', () => {
            if (renameIndex !== null && els.renameInput.value.trim()) {
                renameInPlaylist(renameIndex, els.renameInput.value.trim());
            }
            els.renameModal.classList.remove('active');
            renameIndex = null;
        });

        els.renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') els.renameConfirm.click();
            if (e.key === 'Escape') els.renameCancel.click();
        });

        els.bpmSlider.addEventListener('input', (e) => {
            state.bpm = parseInt(e.target.value);
            els.bpmValue.textContent = state.bpm;
        });

        els.volumeSlider.addEventListener('input', (e) => {
            state.volume = parseInt(e.target.value) / 100;
        });

        els.timeSigBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                const dir = btn.dataset.dir;
                if (target === 'top') {
                    state.beatsPerMeasure = Math.max(1, Math.min(16, state.beatsPerMeasure + (dir === 'up' ? 1 : -1)));
                    els.timeSigTop.textContent = state.beatsPerMeasure;
                    createBeatGrid();
                    if (state.isPlaying) { state.currentBeat = 0; animationStart = null; }
                } else {
                    const values = [1, 2, 4, 8, 16];
                    const idx = values.indexOf(state.noteValue);
                    const newIdx = Math.max(0, Math.min(values.length - 1, idx + (dir === 'up' ? 1 : -1)));
                    state.noteValue = values[newIdx];
                    els.timeSigBottom.textContent = state.noteValue;
                }
            });
        });

        els.subdivBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.subdivBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-checked', 'false'); });
                btn.classList.add('active');
                btn.setAttribute('aria-checked', 'true');
                state.subdivision = parseInt(btn.dataset.subdiv);
            });
        });

        els.flashToggle.addEventListener('click', () => {
            state.flashEnabled = !state.flashEnabled;
            els.flashToggle.classList.toggle('active', state.flashEnabled);
            els.flashToggle.setAttribute('aria-checked', state.flashEnabled);
        });

        els.flashToggle.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); els.flashToggle.click(); }
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                toggle();
            }
        });

        // === Init ===
        createBeatGrid();
    </script>
</body>
</html>
